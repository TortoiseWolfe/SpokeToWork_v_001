# Implementation Plan: Test Security Hardening

**Branch**: `047-test-security` | **Date**: 2025-12-14 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/docs/specs/047-test-security/spec.md`

## Summary

Harden test infrastructure to eliminate SQL injection patterns and hardcoded credentials. The implementation focuses on:

1. Pre-flight env var validation via Vitest setupFile
2. SQL escaping for ALL interpolated values in test queries
3. CI check to block PRs with SQL injection patterns
4. Documentation cleanup to remove hardcoded passwords

## Technical Context

**Language/Version**: TypeScript 5.9 / Node.js 22
**Primary Dependencies**: Vitest 4.0.15, Playwright 1.49.1
**Storage**: N/A (test infrastructure only)
**Testing**: Vitest (unit/integration), Playwright (E2E)
**Target Platform**: Linux (Docker), GitHub Actions CI
**Project Type**: Web application (Next.js 15)
**Performance Goals**: N/A (tests should fail fast on missing env vars)
**Constraints**: Docker-first development, no local npm commands
**Scale/Scope**: ~67 test files with credential fallbacks, 3 files with SQL

## Constitution Check

_GATE: Must pass before implementation._

| Principle                         | Compliance | Notes                                                           |
| --------------------------------- | ---------- | --------------------------------------------------------------- |
| Proper Solutions Over Quick Fixes | PASS       | Implementing comprehensive validation, not band-aids            |
| Root Cause Analysis               | PASS       | Addressing root cause: fallback patterns that enable bad habits |
| Stability Over Speed              | PASS       | Breaking change (tests fail without config) improves stability  |
| Clean Architecture                | PASS       | Centralizing credentials in single module                       |
| No Technical Debt                 | PASS       | Removing all fallbacks, not adding workarounds                  |
| Docker-First Development          | PASS       | All test commands run via Docker                                |

## Project Structure

### Documentation (this feature)

```text
docs/specs/047-test-security/
├── spec.md              # Feature specification
├── plan.md              # This file
├── research.md          # Technical decisions
├── tasks.md             # Task list (generated by /speckit.tasks)
└── checklists/          # Requirements validation
```

### Source Code Changes

```text
tests/
├── setup.ts                    # Add env var validation import
├── setup-env-validation.ts     # NEW: Pre-flight env validation
├── fixtures/
│   └── test-user.ts           # Remove all fallbacks
├── e2e/
│   ├── auth/
│   │   └── welcome-message.spec.ts  # Fix remaining SQL (UUIDs)
│   └── global-setup.ts         # Fix SQL injection patterns

.github/workflows/
└── ci.yml                      # Add SQL injection check step

docs/
├── messaging/QUICKSTART.md     # Replace hardcoded passwords
└── CLAUDE.md                   # Update test user section

public/blog/
└── authentication-supabase-oauth.md  # Replace example passwords
```

## Implementation Phases

### Phase 1: Environment Validation (FR-002, FR-004)

Create pre-flight validation that fails tests before any run if required env vars are missing.

**Files:**

- `tests/setup-env-validation.ts` - NEW: Validation logic
- `tests/setup.ts` - Import validation
- `vitest.config.ts` - May need setupFiles order adjustment

**Required Env Vars:**

```
TEST_USER_PRIMARY_EMAIL
TEST_USER_PRIMARY_PASSWORD
TEST_USER_SECONDARY_EMAIL
TEST_USER_SECONDARY_PASSWORD
TEST_USER_TERTIARY_EMAIL
TEST_USER_TERTIARY_PASSWORD
TEST_USER_ADMIN_EMAIL
TEST_USER_ADMIN_PASSWORD (if admin tests exist)
```

### Phase 2: Remove Credential Fallbacks (FR-003)

Update test-user.ts to throw errors instead of using fallbacks.

**Before:**

```typescript
export const TEST_EMAIL =
  process.env.TEST_USER_PRIMARY_EMAIL || 'test@example.com';
```

**After:**

```typescript
export const TEST_EMAIL = process.env.TEST_USER_PRIMARY_EMAIL;
// Validation happens in setup-env-validation.ts
```

### Phase 3: SQL Injection Fixes (FR-001)

Update all SQL queries to use escapeSQL() for ALL interpolated values.

**Target Files:**

- `tests/e2e/auth/welcome-message.spec.ts` - UUIDs on lines 88, 93, 101, 161-162
- `tests/e2e/auth/complete-flows.spec.ts` - Audit for SQL patterns
- `tests/e2e/global-setup.ts` - Audit for SQL patterns

**escapeSQL Pattern:**

```typescript
function escapeSQL(value: string): string {
  return value.replace(/'/g, "''");
}

// Usage
const query = `SELECT * FROM users WHERE id = '${escapeSQL(userId)}'`;
```

### Phase 4: CI SQL Injection Check (FR-005)

Add grep-based check in CI pipeline.

**Approach:**

```yaml
- name: Check for SQL injection patterns
  run: |
    # Find SQL interpolation without escapeSQL
    if grep -rn --include="*.spec.ts" --include="*.test.ts" \
      "'\${[^}]*}'" tests/ | grep -v "escapeSQL"; then
      echo "ERROR: Found SQL injection patterns without escapeSQL()"
      exit 1
    fi
```

### Phase 5: Documentation Cleanup (FR-006, FR-007)

Replace all hardcoded passwords with placeholders.

**Files:**

- `docs/messaging/QUICKSTART.md` - Use `<your-password>`
- `public/blog/authentication-supabase-oauth.md` - Use `<your-password>`
- `CLAUDE.md` - Use env var references

## Risk Analysis

| Risk                            | Mitigation                                   |
| ------------------------------- | -------------------------------------------- |
| Breaking tests without env vars | Clear error messages with setup instructions |
| False positives in CI SQL check | Allowlist for escapeSQL patterns             |
| Missing env vars in CI          | Ensure GitHub secrets are configured         |
| Developer confusion             | Update CLAUDE.md with clear setup steps      |

## Verification Checklist

- [ ] `grep '|| .TestPassword' tests/` returns zero results
- [ ] `grep '\${[^e]' tests/**/*.spec.ts` (SQL without escape) returns zero results
- [ ] Tests fail immediately with clear error when env vars missing
- [ ] CI blocks PRs with SQL injection patterns
- [ ] Documentation uses placeholder passwords
