#!/bin/bash

# Final secrets scan before push
echo "üîê Final secrets scan before push..."
if [ -d "/app" ] && [ "$PWD" = "/app" ]; then
  # Inside Docker container
  pnpm run gitleaks || { echo "‚ùå Secrets detected! Push blocked."; exit 1; }
elif command -v docker >/dev/null 2>&1 && docker compose ps 2>/dev/null | grep -q spoketowork; then
  # On host with Docker running
  docker compose exec -T spoketowork pnpm run gitleaks || { echo "‚ùå Secrets detected! Push blocked."; exit 1; }
else
  # Fallback to local (if gitleaks is installed)
  if command -v gitleaks >/dev/null 2>&1; then
    gitleaks detect --source . --config .gitleaks.toml || { echo "‚ùå Secrets detected! Push blocked."; exit 1; }
  else
    echo "‚ö†Ô∏è  gitleaks not found - skipping secret scan (install gitleaks for security)"
  fi
fi

# Run full CI validation before pushing to catch all issues
echo "üöÄ Running CI validation before push..."

# Quick validation by default (faster)
# For full validation including coverage and Storybook, use: git push --no-verify && ./scripts/validate-ci.sh
./scripts/validate-ci.sh --quick

if [ $? -ne 0 ]; then
    echo "‚ùå CI validation failed. Please fix issues before pushing."
    echo "Run './scripts/validate-ci.sh' for full validation"
    exit 1
fi