#!/bin/sh
# Clean .next directory contents before running pre-commit checks
echo "ğŸ§¹ Cleaning .next directory before checks..."
rm -rf .next/* .next/.* 2>/dev/null || true

# Secret scanning - run gitleaks on staged files
echo "ğŸ” Scanning for secrets..."
if [ -d "/app" ] && [ "$PWD" = "/app" ]; then
  # Inside Docker container
  pnpm run gitleaks:staged || { echo "âŒ Secrets detected! Commit blocked."; exit 1; }
elif command -v docker >/dev/null 2>&1 && docker compose ps 2>/dev/null | grep -q spoketowork; then
  # On host with Docker running
  docker compose exec -T spoketowork pnpm run gitleaks:staged || { echo "âŒ Secrets detected! Commit blocked."; exit 1; }
else
  # Fallback to local (if gitleaks is installed)
  if command -v gitleaks >/dev/null 2>&1; then
    gitleaks protect --staged --config .gitleaks.toml || { echo "âŒ Secrets detected! Commit blocked."; exit 1; }
  else
    echo "âš ï¸  gitleaks not found - skipping secret scan (install gitleaks for security)"
  fi
fi

# Detect if we're running inside the Docker container
if [ -d "/app" ] && [ "$PWD" = "/app" ]; then
  # We're inside the Docker container, run directly with --no-stash
  echo "ğŸ“¦ Running lint-staged inside Docker container..."
  pnpm exec lint-staged --no-stash
elif command -v docker >/dev/null 2>&1 && docker compose ps 2>/dev/null | grep -q spoketowork; then
  # We're on the host and Docker is running
  echo "ğŸ³ Running lint-staged via Docker..."
  docker compose exec -T spoketowork pnpm exec lint-staged --no-stash
else
  # We're on the host without Docker or Docker isn't running
  echo "ğŸ’» Running lint-staged locally..."
  pnpm lint:staged
fi
