# Implementation Plan: Fix E2E Test Authentication Failures

**Branch**: `062-fix-e2e-auth` | **Date**: 2025-12-22 | **Spec**: [spec.md](./spec.md)

## Summary

Fix 125 E2E test failures by addressing root causes in priority order:

1. Cookie banner blocking (95% of tests) - localStorage pre-seeding
2. Auth setup failures (51% of tests) - URL + element verification
3. State-dependent tests (26% of tests) - proper isolation

## Technical Context

**Language/Version**: TypeScript 5.9, Node.js 22
**Primary Dependencies**: Playwright 1.57, @supabase/supabase-js
**Storage**: localStorage (cookie consent), Supabase Auth (sessions)
**Testing**: Playwright E2E with Chromium/Firefox/WebKit
**Target Platform**: Docker container (pnpm exec playwright test)
**Constraints**: No production code changes, Docker-first, CI/CD compatible

## Constitution Check

| Principle                         | Status  | Notes                                  |
| --------------------------------- | ------- | -------------------------------------- |
| Proper Solutions Over Quick Fixes | ✅ PASS | Root cause fixes, not workarounds      |
| Root Cause Analysis               | ✅ PASS | Analysis report identifies true causes |
| Stability Over Speed              | ✅ PASS | Robust URL+element wait pattern        |
| Clean Architecture                | ✅ PASS | Reusable fixtures, helpers in utils/   |
| No Technical Debt                 | ✅ PASS | Complete solution, no TODOs            |
| Docker-First                      | ✅ PASS | All commands via docker compose exec   |

## Project Structure

### Documentation (this feature)

```text
specs/062-fix-e2e-auth/
├── spec.md              # Feature specification
├── plan.md              # This file
├── research.md          # Technical decisions
├── quickstart.md        # Usage guide for new patterns
└── tasks.md             # Task list (generated by /speckit.tasks)
```

### Source Code Changes

```text
tests/e2e/
├── fixtures/
│   └── auth.fixture.ts       # NEW: Playwright fixture for auth + consent
├── utils/
│   ├── test-user-factory.ts  # MODIFY: Add fail-fast on missing key
│   ├── auth-helpers.ts       # NEW: Login helper with URL+element wait
│   └── consent-helpers.ts    # NEW: Cookie consent pre-seeding
├── global-setup.ts           # MODIFY: Pre-seed storageState file
└── [test files]              # MODIFY: Migrate to new patterns

playwright.config.ts          # MODIFY: Add storageState for consent
```

## Implementation Phases

### Phase 1: Cookie Consent Pre-seeding (Affects 95% of tests)

**Goal**: Eliminate cookie banner from all tests via localStorage pre-seeding.

**Approach**: Create a `storageState.json` file with pre-accepted consent and configure Playwright to use it by default.

**Files**:

- `tests/e2e/fixtures/storage-state.json` - Pre-seeded localStorage
- `playwright.config.ts` - Add `storageState` to `use` config
- `tests/e2e/utils/consent-helpers.ts` - Helper to generate consent state

**Cookie Consent Format** (from `src/utils/consent-types.ts`):

```json
{
  "cookie-consent": {
    "necessary": true,
    "functional": true,
    "analytics": true,
    "marketing": false,
    "timestamp": 1734892800000,
    "version": "1.0.0",
    "lastUpdated": 1734892800000,
    "method": "explicit"
  }
}
```

### Phase 2: Auth Helper with Robust Verification (Affects 51% of tests)

**Goal**: Reliable authentication that verifies both URL and UI state.

**Approach**: Create a shared `loginAndVerify()` helper that:

1. Navigates to /sign-in
2. Fills credentials
3. Clicks submit
4. Waits for URL to NOT be /sign-in (handles various redirects)
5. Verifies "User account menu" element is visible
6. Returns true/false for test assertions

**Files**:

- `tests/e2e/utils/auth-helpers.ts` - New helper module
- `tests/e2e/fixtures/auth.fixture.ts` - Playwright fixture wrapping helper

**Pattern**:

```typescript
export async function loginAndVerify(
  page: Page,
  email: string,
  password: string,
  options?: { timeout?: number }
): Promise<boolean> {
  await page.goto('/sign-in');
  await page.fill('input[type="email"]', email);
  await page.fill('input[type="password"]', password);
  await page.click('button[type="submit"]');

  // Wait for redirect away from sign-in
  await page.waitForURL((url) => !url.pathname.includes('/sign-in'), {
    timeout: options?.timeout ?? 10000,
  });

  // Verify UI state shows authenticated
  const userMenu = page.getByRole('generic', { name: /user account menu/i });
  await expect(userMenu).toBeVisible({ timeout: 5000 });

  return true;
}
```

### Phase 3: Test User Factory Hardening (Fail-fast)

**Goal**: Tests fail immediately with clear error when `SUPABASE_SERVICE_ROLE_KEY` is missing.

**Files**:

- `tests/e2e/utils/test-user-factory.ts` - Add validation at module load

**Change**:

```typescript
// At top of file, before any exports
const REQUIRED_VARS = ['SUPABASE_SERVICE_ROLE_KEY', 'NEXT_PUBLIC_SUPABASE_URL'];
for (const varName of REQUIRED_VARS) {
  if (!process.env[varName]) {
    throw new Error(
      `${varName} required - check .env locally or GitHub Secrets in CI`
    );
  }
}
```

### Phase 4: Migrate Tests to New Patterns

**Goal**: Update failing tests to use new helpers.

**Priority Order** (by impact):

1. `tests/e2e/accessibility/avatar-upload.a11y.test.ts` (14 tests)
2. `tests/e2e/accessibility/colorblind-toggle.spec.ts` (6 tests)
3. `tests/e2e/auth/session-persistence.spec.ts` (4 tests)
4. `tests/e2e/auth/complete-flows.spec.ts` (5 tests)
5. `tests/e2e/auth/protected-routes.spec.ts` (15 tests)
6. `tests/e2e/avatar/upload.spec.ts` (5 tests)

**Pattern for migration**:

```typescript
// BEFORE
test.beforeEach(async ({ page }) => {
  const testEmail = process.env.TEST_USER_PRIMARY_EMAIL!;
  const testPassword = process.env.TEST_USER_PRIMARY_PASSWORD!;
  await page.goto('/sign-in');
  await page.fill('input[type="email"]', testEmail);
  await page.fill('input[type="password"]', testPassword);
  await page.click('button[type="submit"]');
  await page.waitForURL(/\/(profile|verify-email)/, { timeout: 10000 });
});

// AFTER
import {
  createTestUser,
  deleteTestUser,
  generateTestEmail,
} from '../utils/test-user-factory';
import { loginAndVerify } from '../utils/auth-helpers';

let testUser: { id: string; email: string; password: string } | null = null;

test.beforeAll(async () => {
  testUser = await createTestUser(
    generateTestEmail('e2e-a11y'),
    DEFAULT_TEST_PASSWORD
  );
});

test.afterAll(async () => {
  if (testUser) await deleteTestUser(testUser.id);
});

test.beforeEach(async ({ page }) => {
  if (!testUser) test.skip();
  await loginAndVerify(page, testUser.email, testUser.password);
});
```

### Phase 5: Verification

**Goal**: Confirm fixes work across all test categories.

**Steps**:

1. Run auth tests: `docker compose exec spoketowork pnpm exec playwright test tests/e2e/auth/`
2. Run accessibility tests: `docker compose exec spoketowork pnpm exec playwright test tests/e2e/accessibility/`
3. Run full suite 3 times to confirm consistency
4. Verify no cookie banner in any error screenshots
5. Update analysis report with new metrics

## Risk Mitigation

| Risk                              | Mitigation                                               |
| --------------------------------- | -------------------------------------------------------- |
| localStorage format changes       | Use consent-types.ts constants, not hardcoded values     |
| Auth redirect destination changes | Use negation pattern (NOT /sign-in) instead of exact URL |
| Service key rotation breaks tests | Clear error message points to GitHub Secrets             |
| Test parallelism causes conflicts | Each test creates unique user with timestamp email       |

## Rollback Plan

If issues arise:

1. Revert `playwright.config.ts` changes (removes storageState)
2. Individual test files can be reverted independently
3. Test user factory changes are additive (validation only)

## Success Metrics

- [ ] Cookie banner visible in 0% of error screenshots (from 95%)
- [ ] Auth failures reduced from 62 to 0
- [ ] CRITICAL failures reduced from 27 to 0
- [ ] All auth/ tests pass 3 consecutive runs
- [ ] Total unique failures < 20 (from 125)
