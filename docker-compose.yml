services:
  spoketowork:
    build:
      context: .
      dockerfile: docker/Dockerfile
      target: dev
    ports:
      - '${HOST_PORT:-3001}:3000'
      - '${STORYBOOK_PORT:-6007}:6006'
      - '${HMR_PORT:-24679}:24678' # Next.js HMR websocket
    volumes:
      - .:/app
      - node_modules:/app/node_modules
      - next_cache:/app/.next
    env_file:
      - .env
    environment:
      - WATCHPACK_POLLING=true
      - CHOKIDAR_USEPOLLING=true
      - GIT_AUTHOR_NAME=${GIT_AUTHOR_NAME}
      - GIT_AUTHOR_EMAIL=${GIT_AUTHOR_EMAIL}
      - GIT_COMMITTER_NAME=${GIT_AUTHOR_NAME}
      - GIT_COMMITTER_EMAIL=${GIT_AUTHOR_EMAIL}
    dns:
      - 8.8.8.8
      - 1.1.1.1
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3000/']  # Internal container port
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    networks:
      - spoketowork-network

  # Future services can be added here
  # db:
  #   image: postgres:16-alpine
  #   environment:
  #     POSTGRES_DB: spoketowork
  #     POSTGRES_USER: spoketowork
  #     POSTGRES_PASSWORD: spoketowork
  #   volumes:
  #     - postgres_data:/var/lib/postgresql/data
  #   networks:
  #     - spoketowork-network

networks:
  spoketowork-network:
    driver: bridge

volumes:
  postgres_data:
  node_modules:
  next_cache:
